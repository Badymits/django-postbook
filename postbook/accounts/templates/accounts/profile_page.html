{% extends 'base.html' %}
{% load custom_tags %}
{% block content %}

    <section class="grid grid-cols-5 gap-2">
        <div class="col-start-2 col-end-4">
            <div class="flex items-center gap-3">
                <p class="h-[150px] w-[150px] bg-blue-300 rounded-full"></p>
                <div>
                    <p class="text-3xl">{{ user.username }}</p>
                    <p class="text-xl">{{ user.username }}</p>
                </div>
                
            </div>
            <div class=" mt-10 w-full border-b-[1px] border-gray-300 pb-3" id="">
                <ul class="flex {% if request.user == user %} justify-between {% else %} justify-start {% endif %} items-center h-[40px]" id="profile_menu">

                    <a href="{% url 'user' user.id 'posts' %}" data-profile-tab="posts" id="tab_a_elem">
                        <li data-profile-tab="posts" 
                            class="w-[100px] text-center cursor-pointer hover:underline {% if '/posts/' in request.path %} active-tab {% endif %}" 
                            id="profile_tab">
                            Posts
                        </li>
                    </a>
                    
                    
                    <a href="{% url 'user' user.id 'comments' %}" data-profile-tab="comments" id="tab_a_elem">
                        <li data-profile-tab="comments"
                            class="w-[100px] text-center cursor-pointer hover:underline {% if '/comments/' in request.path %} active-tab {% endif %}"  
                            id="profile_tab">
                            Comments
                        </li>
                    </a>
                    <!-- these contents are only available for the logged in user -->
                    {% if request.user == user %}
                        <a href="{% url 'user' user.id 'saved' %}" data-profile-tab="saved" id="tab_a_elem">
                            <li data-profile-tab="saved" 
                                class="w-[100px] text-center cursor-pointer hover:underline {% if '/saved/' in request.path %} active-tab {% endif %}"  
                                id="profile_tab">
                                Saved
                            </li>
                        </a>


                        <a href="{% url 'user' user.id 'upvoted' %}" data-profile-tab="upvoted" id="tab_a_elem">
                            <li data-profile-tab="upvoted" 
                                class="w-[100px] text-center cursor-pointer hover:underline {% if '/upvoted/' in request.path %} active-tab {% endif %}"  
                                id="profile_tab">
                                Upvotes
                            </li>
                        </a>


                        <a href="{% url 'user' user.id 'downvoted' %}" data-profile-tab="downvoted" id="tab_a_elem">
                            <li data-profile-tab="downvoted" 
                                class="w-[100px] text-center cursor-pointer hover:underline {% if '/downvoted/' in request.path %} active-tab {% endif %}"  
                                id="profile_tab">
                                Downvotes
                            </li>
                        </a>
                    {% endif %}

                    <a href="{% url 'user' user.id 'groups' %}" data-profile-tab="groups" id="tab_a_elem">
                        <li data-profile-tab="groups" 
                            class="w-[100px] text-center cursor-pointer hover:underline {% if '/groups/' in request.path %} active-tab {% endif %}" 
                            id="profile_tab">
                            Groups
                        </li>
                    </a>
                    
                </ul>

                {% if request.user == user %}
                    <a href="{% url 'create-post' %}" class="ml-2 mt-6 border-[1px] block hover:border-gray-400 rounded-full p-2 font-normal w-[120px]">
                        <i class="fa fa-plus" aria-hidden="true" class="mr-2"></i>
                        
                        
                        Create Post
                    </a>
                {% endif %}
            </div>

            <div class="mt-6" id="profile_content" onload="">
                {% if '/posts/' in request.path  %}
                    {% include 'accounts/tabs/user_posts.html' with user_posts=user_posts %}


                {% elif '/comments/' in request.path %}
                    {% include 'accounts/tabs/user_comments.html' with user_comments=user_comments %}


                {% elif '/saved/' in request.path %}
                    {% include 'accounts/tabs/user_saved_posts.html' %}


                {% elif '/upvoted/' in request.path %}
                    {% include 'accounts/tabs/user_upvoted_comments.html' %}


                {% elif '/downvoted/' in request.path %}
                    {% include 'accounts/tabs/user_downvoted_comments.html' %}


                {% elif '/groups/' in request.path %}
                    {% include 'accounts/tabs/user_upvoted_comments.html' %}
                    

                {% else %}
                    <p>None</p>

                {% endif %}
            </div>
            
            
        </div>
        <div class="">
            <div class="fixed bg-blue-300 h-[100px] w-[400px] rounded-md">
                {% if request.user.is_authenticated %}
                    <img src="" alt="">
                {% endif %}
            </div>
        </div>
    </section>

    <script type="text/javascript">
        let reset_btn = document.getElementById('resetBtn');
        let post_div = document.querySelectorAll('#post-div');
        let vote_div = document.getElementById('vote_div')
    
        
        for (let i = 0; i < post_div.length; i++){
    
            post_div[i].addEventListener('click', function(e){
                var post_id = post_div[i].querySelector("input").value
                console.log(post_id)
                window.location.href = `http://127.0.0.1:8000/detail-post/${post_id}/`         
            })
        }
        const profile_content = document.getElementById('profile_content')
        $(document).on('click', document, function(e){
            if (e.target.id === 'like_post_btn' || e.target.id === 'like_btn'){
                const parent = e.target.closest('#like_btn_parent')
    
                const option = e.target.getAttribute('data-option')
                const post_id = e.target.getAttribute('data-post')
                const svg_like = parent.querySelector('#like_btn')
                const like_count = parent.querySelector('#like_count')
    
                updateVote(option, post_id, svg_like, parent)
    
            }
    
            if (e.target.id === 'dislike_btn') {
                const parent = e.target.closest('#dislike_btn_parent')
                console.log(parent)
    
                const option = e.target.getAttribute('data-option')
                const post_id = e.target.getAttribute('data-post')
                const svg_dislike = parent.querySelector('#dislike_btn')
                const like_count = parent.querySelector('#dislike_count')
                
                updateVote(option, post_id, svg_dislike, parent)
            }

            if (e.target.id === 'profile_tab' || e.target.id === 'tab_a_elem'){
                const tab = e.target.getAttribute('data-profile-tab')
                console.log('the tab: ', tab)
                const tab_item = e.target

                console.log('tab_item: ', tab_item)
                const tab_a_elem = e.target.querySelector('#tab_a_elem').getAttribute('data-profile-tab')

                console.log('tab_a_elem: ', tab_a_elem)
                activeTab(tab, tab_item, tab_a_elem)
            }

            // comment votes handling
            if (e.target.id === 'comment_like_btn'){
                const parent = e.target.closest('#comment_like_btn_parent')

                const option = e.target.getAttribute('data-option')
                const comment_id = e.target.getAttribute('data-comment')
                const svg_like = parent.querySelector('#comment_like_btn')

                updateCommentVote(option, comment_id, svg_like, parent)
            }

            if (e.target.id === 'comment_dislike_btn'){
                const parent = e.target.closest('#comment_dislike_btn_parent')

                const option = e.target.getAttribute('data-option')
                const comment_id = e.target.getAttribute('data-comment')
                const svg_dislike = parent.querySelector('#comment_dislike_btn')

                updateCommentVote(option, comment_id, svg_dislike, parent)
            }
        })

        // check data profile tab value and render the component based on its value
        function activeTab(tab, tab_item, tab_a_elem){

            $('ul#profile_menu').find('li.active-tab').removeClass('active-tab')

            
            if (tab === 'posts' || tab_a_elem === 'posts'){
                // add active tab
                tab_item.classList.add('active-tab')     
            }
            else if (tab === 'comments' || tab_a_elem === 'comments'){
                tab_item.classList.add('active-tab')
            } 
            else if (tab === 'saved'){
                tab_item.classList.add('active-tab')
            } 
            else if (tab === 'upvoted'){
                tab_item.classList.add('active-tab')
            } 
            else if (tab === 'downvoted'){
                tab_item.classList.add('active-tab')
            }
            else if (tab === 'groups'){
                tab_item.classList.add('active-tab')
            }
        }

        function updateCommentVote(option, comment_id, svg, parent){
            console.log(parent)
            $.ajax({
                url: `/update-vote-comment/${comment_id}/`,
                data:{
                    option: option
                },
                type: 'GET',
                success: function(res){
                    let dislike_count = parent.querySelector('#comment_dislike_count')
                    let like_count = parent.querySelector('#comment_like_count')

                    if (option === 'like'){
                        // user clicks on a comment that they already liked
                        if (res.option === 'removed like'){
                            svg.classList.remove('text-red-400')
                            like_count.innerHTML = res.like_count
                        
                        // liking the comment
                        } else  {                            
                            
                            let div_parent = parent.parentElement // this is the comment actions div

                            const dislike_counter = div_parent.querySelector('#comment_dislike_count')
                            const dislike_svg = div_parent.querySelector('#comment_dislike_btn') // for the svg

                            like_count.innerHTML = res.like_count
                            dislike_counter.innerHTML = res.dislike_count

                            dislike_svg.classList.remove('text-blue-400')
                            dislike_svg.classList.add('hover:text-blue-400')
                            svg.classList.add('text-red-400')
                            
                        }


                    // dislike option logic
                    } else {
                        // when user clicks on an already disliked comment
                        if (res.option === 'removed dislike'){
                            
                            svg.classList.remove('text-blue-400')
                            dislike_count.innerHTML = res.dislike_count

                        // first time clicking on the dislike btn
                        } else {
                            let div_parent = parent.parentElement // this is the comment actions div

                            const dislike_counter = div_parent.querySelector('#comment_dislike_count')
                            const like_svg = div_parent.querySelector('#comment_like_btn')
                            const like_count = div_parent.querySelector('#comment_like_count')

                            like_count.innerHTML = res.like_count
                            dislike_count.innerHTML = res.dislike_count

                            like_svg.classList.remove('text-red-400')
                            like_svg.classList.add('hover:text-red-400')
                            svg.classList.add('text-blue-400')
                        }
                    }
                },
                error: function(err){
                    alert('There was an error, do something about it')
                }
            })
        }

        function updateVote(option, post_id, svg, parent){

            $.ajax({
                url: `/update-vote-post/${post_id}/`,
                data:{
                    option: option
                },
                type: 'GET',
                success: function(res){
                    const div_parent = parent.parentElement
                    let dislike_count = div_parent.querySelector('#dislike_count')
                    let like_count = div_parent.querySelector('#like_count')
                    if (option === 'like'){
                        if (res.option === 'removed like'){
                            svg.classList.remove('text-red-400')
                            like_count.innerHTML = res.like_count
                            
                        } else  {                            
                            let dislike = div_parent.querySelector('#dislike_btn')
                            
                            like_count.innerHTML = res.like_count
                            dislike_count.innerHTML = res.dislike_count

                            dislike.classList.remove('text-blue-400')
                            dislike.classList.add('hover:text-blue-400')
                            svg.classList.add('text-red-400')
                            
                        }
                    } else {
                        if (res.option === 'removed dislike'){
                            svg.classList.remove('text-blue-400')
                            dislike_count.innerHTML = res.dislike_count
                        } else {
                            let like = div_parent.querySelector('#like_btn')
                            
                            like_count.innerHTML = res.like_count
                            dislike_count.innerHTML = res.dislike_count

                            like.classList.remove('text-red-400')
                            like.classList.add('hover:text-red-400')
                            svg.classList.add('text-blue-400')
                        }
                    }
                            
                    
                },
                error: function(err){
                    alert(err)
                }
            })
        }
    </script>

{% endblock %}



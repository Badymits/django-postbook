{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block content %}

    <section class="grid grid-cols-5 gap-2">
        
        <div class=" col-start-2 col-end-4">
            <div class="w-full bg-gray-300 h-[60px] flex items-center justify-center w-full gap-[5px] px-4 rounded-xl">
                Profile Image
                
                <input type="text" class="w-full h-[40px] rounded-lg" placeholder="Create Post" onclick='createPostUrl()'>
                <div>
                    image here
                </div>
                <div>
                    Paste link
                </div>
            </div>
            <div class="pt-2">
                {% if posts %}
                <!-- {% postVotes posts %} -->
                    {% for post in posts %}
                    <div class="flex gap-2 w-full bg-gray-200 mb-6 relative   rounded-sm hover:border-black border-[1px] cursor-pointer">
                        <div class="w-[50px] bg-gray-300 border-r-[1px] border-black px-4">
                            <div class=" flex flex-col items-center gap-2 py-2" id="vote_div">
                                <button class="flex items-center gap-2 text-xl hover:bg-gray-300 rounded-md " id="like_btn_parent">
                                    {% is_liked post.id request.user as liked %}
                                    {% if liked %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"  data-option="like"
                                            class="text-red-400" id="like_btn" data-post="{{ post.id }}">
                                            <path fill="currentColor" id="like_btn" data-post="{{ post.id }}"  data-option="like"
                                            d="M12.781 2.375c-.381-.475-1.181-.475-1.562 0l-8 10A1.001 1.001 0 0 0 4 14h4v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-7h4a1.001 1.001 0 0 0 .781-1.625zM15 12h-1v8h-4v-8H6.081L12 4.601L17.919 12z"/>
                                        </svg>    
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" 
                                            class="hover:text-red-400" id="like_post_btn" data-post="{{ post.id }}" data-option="like">
                                            <path fill="currentColor" id="like_btn" data-post="{{ post.id }}"  data-option="like"
                                            d="M12.781 2.375c-.381-.475-1.181-.475-1.562 0l-8 10A1.001 1.001 0 0 0 4 14h4v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-7h4a1.001 1.001 0 0 0 .781-1.625zM15 12h-1v8h-4v-8H6.081L12 4.601L17.919 12z"/>
                                        </svg>  
                                    {% endif %}
                                    <p id="like_count"> {{ post.get_likes }} </p>
                                </button>
                                <button class=" flex items-center gap-2 text-xl hover:bg-gray-300  rounded-md" id="dislike_btn_parent">
                                    {% is_disliked post.id request.user as disliked %}
                                    {% if disliked %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" data-option="dislike"
                                        class="text-blue-400" id="dislike_btn" data-post="{{ post.id }}">
                                        <path fill="currentColor"  id="dislike_btn" data-post="{{ post.id }}" data-option="dislike"
                                        d="M20.901 10.566A1.001 1.001 0 0 0 20 10h-4V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v7H4a1.001 1.001 0 0 0-.781 1.625l8 10a1 1 0 0 0 1.562 0l8-10c.24-.301.286-.712.12-1.059M12 19.399L6.081 12H10V4h4v8h3.919z"/>
                                    </svg>
                                    {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" data-option="dislike"
                                        class="hover:text-blue-400" id="dislike_btn" data-post="{{ post.id }}">
                                        <path fill="currentColor"  id="dislike_btn" data-post="{{ post.id }}" data-option="dislike"
                                        d="M20.901 10.566A1.001 1.001 0 0 0 20 10h-4V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v7H4a1.001 1.001 0 0 0-.781 1.625l8 10a1 1 0 0 0 1.562 0l8-10c.24-.301.286-.712.12-1.059M12 19.399L6.081 12H10V4h4v8h3.919z"/>
                                    </svg>
                                    {% endif %}
                                    <p id="dislike_count"> {{ post.get_dislikes }} </p>
                                </button>
                                
                            </div>
                        </div>
                        <div class="py-4 w-full" id="post-div"   
                        >
                            <input type="hidden" name="post_id" id="post_id" value="{{ post.id }}" class="post_id">
                            <p class="text-4xl pb-2">{{ post.title }}</p>
                            <p class="text-sm font-thin">Posted by: <a href="{% url 'user' post.user.id 'posts'  %}" class="hover:underline"> {{ post.user.username }} </a> {{ post.date_posted|timesince }}</p>
                            
                            {% if post.image %}

                                <img src="{{ post.image.url }}" alt="{{ post.image }}" class="object-fit max-h-[350px] max-w-[350px] mx-auto my-4">

                            {% endif %}

                            {% if post.body %}
                                <p class="pt-3">{{ post.body }}</p>
                            {% endif %}
                            
                            <div class="h-[50px] flex items-center justify-start pt-5 text-md relative" id="post_actions">
                               
                            
                                <div class="hover:bg-gray-300 flex items-center justify-center mx-2 gap-1 py-4 ">
                                    <i class="fa fa-comments-o" aria-hidden="true"></i>
                                    <p>{{ post.comment_set.all|length }} {{ post.comment_set.count|pluralize:"comment,comments" }}</p>
                                </div>

                                <div class="hover:bg-gray-300 flex items-center justify-center mx-2 gap-1 py-4 px-3 ">
                                    <i class="fa fa-share-square-o" aria-hidden="true"></i>
                                    <p>Share post</p>
                                </div>

                                <div class="hover:bg-gray-300 flex items-center justify-center mx-2 gap-1 py-4 px-2 ">
                                    <i class="fa fa-bookmark-o" aria-hidden="true"></i>
                                    <p>Save</p>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                        
                        

                    {% endfor %}
                {% else %}
                    <p>No posts...</p>
                {% endif %}

                
            </div>
        </div>
        <div class="">
            <div class="fixed bg-gray-300 h-[500px] w-[400px] rounded-lg p-4">
                <p class="text-2xl font-thin">About PostBook...</p>
                <br>
                <p class="text-justify">
                    This is a website that is inspired heavily by Reddit. I enjoy building websites
                    particularly social media types since it has the basic CRUD functionalities which 
                    is essential to know in most if not all programming apps. Yes I know there are many better 
                    examples of social media apps like Facebook and X (formerly Twitter). Even the name of this app
                    is derived from Facebook. But, this is a starting point for me so bear with it :P.
                </p>
                <p class="mt-10 text-lg w-full">
                    Anyway...Enjoy
                    <br>
                    
                </p>
                <a href="{% url 'create-post' %}" class="bg-blue-200 hover:bg-blue-100 duration-100 block w-full text-center h-[40px]
                    my-auto leading-10 rounded-full mt-2 text-lg">Create Post
                </a>
            </div>
        </div>
        
        
    </section>
    <a href="{% url 'home' %}" class="sticky float-right right-[25em] bottom-5 bg-gray-400 hover:bg-gray-300 w-[150px] 
    py-3 rounded-full text-center text-lg text-gray-100 hover:text-gray-600 opacity-0 translate-y-[100px] duration-200 ease-in-out" id="resetBtn">Back to Top</a>
    <script type="text/javascript">
        let reset_btn = document.getElementById('resetBtn');
        let post_div = document.querySelectorAll('#post-div');
        let vote_div = document.getElementById('vote_div')

        
        for (let i = 0; i < post_div.length; i++){

            post_div[i].addEventListener('click', function(e){
                var post_id = post_div[i].querySelector("input").value
                console.log(post_id)
                window.location.href = `http://127.0.0.1:8000/detail-post/${post_id}/`         
            })
        }        
        function createPostUrl(){
            window.location.href = "{% url 'create-post' %}"; 
        }
        // when user scrolls down, a button to reset to top of page will appear
        window.addEventListener('scroll', function(){
            if(window.scrollY > 300){

                reset_btn.classList.remove('opacity-0')
                reset_btn.classList.remove('translate-y-[100px]')

                reset_btn.classList.add('opacity-100')
                reset_btn.classList.add('translate-y-0')


            } else {
                reset_btn.classList.remove('opacity-100')
                reset_btn.classList.remove('translate-y-0')


                reset_btn.classList.add('ease-out')
                reset_btn.classList.add('translate-y-[100px]')
            }
        })

        $(document).on('click', document, function(e){
            if (e.target.id === 'like_post_btn' || e.target.id === 'like_btn'){
                const parent = e.target.closest('#like_btn_parent')
    
                const option = e.target.getAttribute('data-option')
                const post_id = e.target.getAttribute('data-post')
                const svg_like = parent.querySelector('#like_btn')
                const like_count = parent.querySelector('#like_count')
    
                updateVote(option, post_id, svg_like, parent)
    
            }
    
            if (e.target.id === 'dislike_btn') {
                const parent = e.target.closest('#dislike_btn_parent')
                console.log(parent)
    
                const option = e.target.getAttribute('data-option')
                const post_id = e.target.getAttribute('data-post')
                const svg_dislike = parent.querySelector('#dislike_btn')
                const like_count = parent.querySelector('#dislike_count')
                
                updateVote(option, post_id, svg_dislike, parent)
            }
        })

        function updateVote(option, post_id, svg, parent){

            $.ajax({
                url: `/update-vote-post/${post_id}/`,
                data:{
                    option: option
                },
                type: 'GET',
                success: function(res){
                    const div_parent = parent.parentElement
                    let dislike_count = div_parent.querySelector('#dislike_count')
                    let like_count = div_parent.querySelector('#like_count')
                    if (option === 'like'){
                        if (res.option === 'removed like'){
                            svg.classList.remove('text-red-400')
                            like_count.innerHTML = res.like_count
                            
                        } else  {                            
                            let dislike = div_parent.querySelector('#dislike_btn')
                            
                            like_count.innerHTML = res.like_count
                            dislike_count.innerHTML = res.dislike_count

                            dislike.classList.remove('text-blue-400')
                            dislike.classList.add('hover:text-blue-400')
                            svg.classList.add('text-red-400')
                            
                        }
                    } else {
                        if (res.option === 'removed dislike'){
                            svg.classList.remove('text-blue-400')
                            dislike_count.innerHTML = res.dislike_count
                        } else {
                            let like = div_parent.querySelector('#like_btn')
                            
                            like_count.innerHTML = res.like_count
                            dislike_count.innerHTML = res.dislike_count

                            like.classList.remove('text-red-400')
                            like.classList.add('hover:text-red-400')
                            svg.classList.add('text-blue-400')
                        }
                    }
                            
                    
                },
                error: function(err){
                    alert(err)
                }
            })
        }
    </script>

{% endblock %}